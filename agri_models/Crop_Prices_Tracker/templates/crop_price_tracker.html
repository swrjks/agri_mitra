<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crop Price Tracker</title>
    <link rel="icon" type="image/png" href="/AgriTech/images/logo.png">
    <link rel="stylesheet" href="../static/styles.css">
    <link rel="stylesheet" href="../../theme.css">
  </head>

  <body>
    <div class="header">
      <button class="theme-toggle" aria-label="Toggle dark/light mode" style="background: rgba(46, 125, 50, 0.1); border: 1px solid rgba(46, 125, 50, 0.3); color: #2e7d32; position: absolute; top: 20px; right: 20px; z-index: 1000;">
        <i class="fas fa-sun sun-icon"></i>
        <i class="fas fa-moon moon-icon"></i>
        <span class="theme-text">Light</span>
      </button>
      <a href="/main.html" class="back-button">Back to Main</a>
      <h2>üåæ Crop Price Tracker</h2>
      <div style="width: 120px"></div>
    </div>

    <div class="form-container">
      <form method="POST" id="priceForm">
        <div class="form-row">
          <label for="crop" class="form-label">Select Crop</label>
          <select name="crop" id="crop" required>
            <option value="">-- Choose your crop --</option>
            {% for crop in crops %}
            <option value="{{ crop }}">{{ crop }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-row">
          <label for="state" class="form-label">Select State</label>
          <select name="state" id="state" required disabled>
            <option value="">-- First select a crop --</option>
          </select>
        </div>

        <div class="form-row">
          <label for="market" class="form-label">Select Market</label>
          <select name="market" id="market" required disabled>
            <option value="">-- First select a state --</option>
          </select>
        </div>

        <button type="submit" class="submit-button" id="submitBtn" disabled>
          Track Prices
        </button>
      </form>
    </div>

    {% if error %}
    <div class="error"><strong>‚ö†Ô∏è Error:</strong> {{ error }}</div>
    {% endif %} {% if result %}
    <div class="results-container">
      <h3>üìà Latest Market Prices</h3>
      <div class="price-grid">
        {% for row in result %}
        <div class="price-card">
          <div class="price-date">{{ row['arrival_date'] }}</div>
          <div class="price-amount">‚Çπ{{ row['modal_price'] }} / quintal</div>
          <div class="price-location">
            {{ row['market'] }}, {{ row['state'] }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <script>
      const cropSelect = document.getElementById("crop");
      const stateSelect = document.getElementById("state");
      const marketSelect = document.getElementById("market");
      const submitBtn = document.getElementById("submitBtn");

      // Enable/disable submit button based on form completion
      function updateSubmitButton() {
        const isFormComplete =
          cropSelect.value && stateSelect.value && marketSelect.value;
        submitBtn.disabled = !isFormComplete;
      }

      cropSelect.addEventListener("change", function () {
        const loadingText = "Loading states...";
        stateSelect.innerHTML = `<option value="">${loadingText}</option>`;
        stateSelect.disabled = true;
        stateSelect.classList.add("loading");

        fetch("/get_states?crop=" + this.value)
          .then((res) => res.json())
          .then((states) => {
            stateSelect.innerHTML =
              '<option value="">-- Select State --</option>';
            states.forEach((state) => {
              stateSelect.innerHTML += `<option value="${state}">${state}</option>`;
            });
            stateSelect.disabled = false;
            stateSelect.classList.remove("loading");

            marketSelect.innerHTML =
              '<option value="">-- First select a state --</option>';
            marketSelect.disabled = true;
            updateSubmitButton();
          })
          .catch((error) => {
            console.error("Error fetching states:", error);
            stateSelect.innerHTML =
              '<option value="">-- Error loading states --</option>';
            stateSelect.classList.remove("loading");
          });
      });

      // Load markets based on selected state
      stateSelect.addEventListener("change", function () {
        const crop = cropSelect.value;
        const state = this.value;

        if (state) {
          const loadingText = "Loading markets...";
          marketSelect.innerHTML = `<option value="">${loadingText}</option>`;
          marketSelect.disabled = true;
          marketSelect.classList.add("loading");

          fetch(`/get_markets?crop=${crop}&state=${state}`)
            .then((res) => res.json())
            .then((markets) => {
              marketSelect.innerHTML =
                '<option value="">-- Select Market --</option>';
              markets.forEach((market) => {
                marketSelect.innerHTML += `<option value="${market}">${market}</option>`;
              });
              marketSelect.disabled = false;
              marketSelect.classList.remove("loading");
              updateSubmitButton();
            })
            .catch((error) => {
              console.error("Error fetching markets:", error);
              marketSelect.innerHTML =
                '<option value="">-- Error loading markets --</option>';
              marketSelect.classList.remove("loading");
            });
        } else {
          marketSelect.innerHTML =
            '<option value="">-- First select a state --</option>';
          marketSelect.disabled = true;
          updateSubmitButton();
        }
      });

      marketSelect.addEventListener("change", updateSubmitButton);

      // Form submission with loading state
      document
        .getElementById("priceForm")
        .addEventListener("submit", function () {
          submitBtn.classList.add("loading");
          submitBtn.textContent = "Fetching Prices...";
        });

      updateSubmitButton();
    </script>
    <script src="../../theme.js"></script>
  </body>
</html>
